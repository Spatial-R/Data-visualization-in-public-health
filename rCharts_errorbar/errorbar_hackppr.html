<!doctype HTML>
<meta charset = 'utf-8'>
<html>
  <head>
    <link rel='stylesheet' href="http://netdna.bootstrapcdn.com/bootswatch/2.3.1/cosmo/bootstrap.min.css">
     <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" >
    <link rel='stylesheet' href="http://getbootstrap.com/2.3.2/assets/js/google-code-prettify/prettify.css">
    <link rel='stylesheet' href="http://aozora.github.io/bootplus/assets/css/docs.css">
    
    <script src='js/d3.v3.js' type='text/javascript'></script>
    <script src='js/errorbar.js' type='text/javascript'></script>
    <script src='js/d3-grid.js' type='text/javascript'></script>
    
    <style>
    .rChart {
      display: block
      margin: auto auto;
      width: 100%;
      height: 400px;
    }
    /*
    body {
      margin-top: 60px;
    }
    */
    </style>
    
  </head>
  <body>
    <div class='container'>
      <div class='row'>
        <div class='span8'>
          <div class="bs-docs-example">
            <div id='plot' class='rChart nvd3Plot rCharts_errorbar'></div>
          <br/>
<pre><code class='r'>
#hacky way of doing ppr; know this is still not really acceptable
final$player_ppr &lt;- paste0(final$player,&quot;_&quot;,final$ppr)
#then get the median rank for each player which will serve as a key for rank
final$ave_median &lt;- lapply(
  final$player,
  FUN=function(x){
    return(median(final[which(final$player==x),]$ave) )
  }
)
ePlotPPR$setLib(path)
ePlotPPR$templates$script = paste0(path,&quot;/layouts/chart.html&quot;)
#not the way Ramnath intended but we will hack away
ePlotPPR$params =  list(
  data = subset(subset(final,category %in% c(&quot;wr&quot;)), rank &lt; 20),
  height = 500,
  width = 1000,
  x = &quot;player_ppr&quot;,
  y = &quot;ave&quot;,
  color = &quot;player&quot;,
  radius = 4,
  sort = list( var = &quot;ave_median&quot; ),
  whiskers = &quot;#!function(d){return [d.ave - 1.96 * d.stddev, d.ave + 1.96 * d.stddev]}!#&quot;
)
ePlotPPR

</code></pre>
</div>
        </div>
      </div>
    </div>
      
    <style>
.axis line, .axis path {
  fill: none;
  shape-rendering: crispEdges;
  stroke: lightgrey;
}
.axis text {
  fill: grey;
  font-family: "Source Sans Pro", sans-serif;
  font-size: 10px;
}
</style>

      <script>
       debugger;
      (function(){
        var opts = {
 "data": {
 "rank": [      1,      2,      3,      4,      5,      6,      7,      8,      9,     10,     11,     12,     13,     14,     15,     16,     17,     18,     19,      1,      2,      3,      4,      5,      6,      7,      8,      9,     10,     11,     12,     13,     14,     15,     16,     17,     18,     19 ],
"player": [ "Calvin Johnson", "Brandon Marshall", "Demaryius Thomas", "A.J. Green", "Julio Jones", "Andre Johnson", "Vincent Jackson", "Dez Bryant", "Victor Cruz", "Randall Cobb", "Larry Fitzgerald", "Reggie Wayne", "Jordy Nelson", "Wes Welker", "DeSean Jackson", "Pierre Garcon", "Hakeem Nicks", "Marques Colston", "Steve Smith", "Calvin Johnson", "Brandon Marshall", "Demaryius Thomas", "A.J. Green", "Andre Johnson", "Victor Cruz", "Julio Jones", "Vincent Jackson", "Randall Cobb", "Larry Fitzgerald", "Reggie Wayne", "Dez Bryant", "Wes Welker", "Jordy Nelson", "DeSean Jackson", "Pierre Garcon", "Hakeem Nicks", "Marques Colston", "Steve Smith" ],
"best": [      1,      1,      1,      1,      1,      1,      2,      2,      2,      3,      1,      5,      2,      4,      5,      5,      4,      5,      7,      1,      1,      1,      1,      1,      1,      1,      2,      3,      1,      2,      2,      4,      2,      4,      2,      7,      5,      5 ],
"worst": [     14,     11,     15,     18,     18,     37,     17,     23,     30,     24,     35,     27,     27,     31,     35,     39,     36,     54,     40,     11,     10,     16,     19,     17,     22,     23,     18,     23,     45,     23,     38,     27,     28,     34,     49,     37,     48,     32 ],
"ave": [    1.8,    3.6,    3.8,    4.2,      7,    7.6,    7.9,      9,    9.2,   10.6,   10.7,   13.1,   13.1,   14.7,   15.5,   17.3,     18,   18.7,   20.7,    2.3,    3.2,    4.8,    4.8,      7,    7.8,    8.9,    9.4,    9.9,   11.3,   11.3,   11.6,   12.6,   15.3,   15.7,     18,   18.4,   20.3,   20.5 ],
"stddev": [    1.7,    1.9,    2.6,    2.5,    3.3,    3.8,    3.2,    4.6,    3.7,    3.8,    6.8,    3.4,      4,    4.6,    4.7,    5.8,    5.1,    6.8,    5.2,    2.1,    1.9,    3.4,    3.1,    3.5,    3.7,    4.9,      4,    3.6,    8.5,      4,    6.6,    4.6,      5,    5.6,    7.1,    5.6,    7.8,    5.3 ],
"category": [ "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr", "wr" ],
"ppr": [ "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5", "5" ],
"pos": [ null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null ],
"matchup": [ null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null ],
"player_ppr": [ "Calvin Johnson_N", "Brandon Marshall_N", "Demaryius Thomas_N", "A.J. Green_N", "Julio Jones_N", "Andre Johnson_N", "Vincent Jackson_N", "Dez Bryant_N", "Victor Cruz_N", "Randall Cobb_N", "Larry Fitzgerald_N", "Reggie Wayne_N", "Jordy Nelson_N", "Wes Welker_N", "DeSean Jackson_N", "Pierre Garcon_N", "Hakeem Nicks_N", "Marques Colston_N", "Steve Smith_N", "Calvin Johnson_5", "Brandon Marshall_5", "Demaryius Thomas_5", "A.J. Green_5", "Andre Johnson_5", "Victor Cruz_5", "Julio Jones_5", "Vincent Jackson_5", "Randall Cobb_5", "Larry Fitzgerald_5", "Reggie Wayne_5", "Dez Bryant_5", "Wes Welker_5", "Jordy Nelson_5", "DeSean Jackson_5", "Pierre Garcon_5", "Hakeem Nicks_5", "Marques Colston_5", "Steve Smith_5" ],
"ave_median": [
   4.75,
  7.25,
 10.95,
  11.5,
 20.25,
  17.1,
 21.05,
 24.55,
  18.6,
  24.2,
  24.4,
 27.05,
 31.15,
  29.4,
 33.55,
 37.05,
 38.05,
  40.9,
 42.95,
  4.75,
  7.25,
 10.95,
  11.5,
  17.1,
  18.6,
 20.25,
 21.05,
  24.2,
  24.4,
 27.05,
 24.55,
  29.4,
 31.15,
 33.55,
 37.05,
 38.05,
  40.9,
 42.95 
] 
},
"height":    400,
"width":   700,
"x": "player_ppr",
"y": "ave",
"color": "player",
"radius":      4,
"sort": {
 "var": "ave_median" 
},
"whiskers": function(d){return [d.ave - 1.96 * d.stddev, d.ave + 1.96 * d.stddev]} 
};
        //var margin = ,
        //  width =  - margin.left - margin.right,
        // height =  - margin.top - margin.bottom;

        var color = d3.scale.category20();

        var svg = d3.select("#plot").append("svg")
            .attr("width", opts.width)
            .attr("height", opts.height)

        //d3.json("fantasy.json", function (error, data) {

          if(!(opts.margin)) opts.margin = { top: 10, right: 50, bottom: 20, left: 50 }

          //data transform since rCharts does not use toJSONArray() by default
          var data = [];

          opts.data[d3.keys(opts.data)[0]].forEach(function(d,i){
            var tempobj = {};
            d3.keys(opts.data).forEach(function(key){
              tempobj[key] = opts.data[key][i];
            });
            data.push(tempobj);
          });

          //if no facet then just make blank object
          if(!(opts.facet)) opts.facet = {};
          //if facet not provided for x or y make Dummy variable
          opts.facet.x = opts.facet.x ? opts.facet.x : "Dummy"
          opts.facet.y = opts.facet.y ? opts.facet.y : "Dummy"    
          if(opts.facet.x === "Dummy" || opts.facet.y === "Dummy") {
            data.forEach(function(d){
              d.Dummy = 1;
            })
          }
          var rows = d3.set(data.map(function(d){return d[opts.facet.y]})).values();
          var nrow = rows.length;
          var cols = d3.set(data.map(function(d){return d[opts.facet.x]})).values()
          var ncol = cols.length;
  
          var tuples = d3.merge(
            rows.map(function(row,irow){
              return cols.map(function(col,icol){
                return {key:row + "~" + col, values: {"row":irow, "col":icol} }
              })
            })
          );
    
          var grid = d3.layout.grid()
            .rows( nrow )
            .cols( ncol )
            .size([ opts.width, opts.height-100])
            .bands();

          var svgGrid = d3.select("#plot").append("svg")
            .attr("width", opts.width)
            .attr("height", opts.height);
          
          grid(tuples);  //apply d3-grid layout

          tuples.forEach(function(cell,cellnum) {
            // Filter the data set for the x and y facets
            var filteredData = data.filter(function(d){
              return d[opts.facet.x] == cell.key.split('~')[1]
            });
            //split for now but could easily do all in one filter
            filteredData = filteredData.filter(function(d){
              return d[opts.facet.y] == cell.key.split('~')[0]
            });
    
            filteredData = d3.nest()
              .key(function(d){ return d[opts.facet.x] + "~" + opts.facet.y} ).sortKeys(d3.ascending)
              //.key(function(d){ return d[opts.group] } )
              .entries(filteredData);

            var errorbar = d3.svg.errorbar()
              .height(grid.nodeSize()[1]- opts.margin.top - opts.margin.bottom )
              .width(grid.nodeSize()[0] - opts.margin.right - opts.margin.left)
              .xVar(opts.x)
              .yVar(opts.y)
              .colorVar(opts.color)
              .color(color)
              .radius(opts.radius);

            if(opts.whiskers) {
              if (typeof opts.whiskers === "function") {
                errorbar.whiskers(opts.whiskers)
              } else {
                errorbar.whiskers(
                  function(d) {
                    return [d[opts.whiskers[0]], d[opts.whiskers[1]]]
                  }
                );
              }
            }; 

            if(opts.sort) {
              errorbar.sort(opts.sort);
            }

            var g = svg //.selectAll("g").data(filteredData);
              .append("g").data(filteredData) //g.enter().append("g")
                .attr("transform","translate(" + (+cell.x + opts.margin.right) + "," + (+cell.y+opts.margin.top) + ")")
                .call(errorbar);

          });
      })();
      </script>
    
  </body>
  <!-- Google Prettify -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
  <script 
    src='https://google-code-prettify.googlecode.com/svn-history/r232/trunk/src/lang-r.js'>
  </script>
  <script>
    var pres = document.getElementsByTagName("pre");
    for (var i=0; i < pres.length; ++i) {
      pres[i].className = "prettyprint linenums";
    }
    prettyPrint();
  </script>
</html>
