<!doctype HTML>
<meta charset = 'utf-8'>
<html>
  <head>
    
    <script src='http://d3js.org/d3.v3.min.js' type='text/javascript'></script>
    <script src='http://timelyportfolio.github.io/rCharts_errorbar/js/d3-grid.js' type='text/javascript'></script>
    <script src='http://timelyportfolio.github.io/rCharts_errorbar/js/errorbar.js' type='text/javascript'></script>
    
    <style>
    .rChart {
      display: block;
      margin-left: auto; 
      margin-right: auto;
      width: 900px;
      height: 500px;
    }  
    </style>
    
  </head>
  <body>
    
    <style>
.axis line, .axis path {
  fill: none;
  shape-rendering: crispEdges;
  stroke: lightgrey;
}
.axis text {
  fill: grey;
  font-family: "Source Sans Pro", sans-serif;
  font-size: 10px;
}
</style>

      <script>
       debugger;
      (function(){
        var opts = {
 "data": {
 "Country": [ "USA", "Spain", "Germany", "United Kingdom", "Italy", "France", "Switzerland", "Brazil", "Canada", "China", "Portugal", "Norway", "Greece", "Sweden", "Belgium", "Austria", "Japan", "Mexico", "Argentina", "Russia", "Australia", "Chile", "Malaysia", "India", "Poland", "Colombia", "Korea(South)", "Lituania", "Hong Kong", "Indonesia", "Netherlands", "Peru", "Singapore", "Czech Republic", "New Zealand", "Finland", "Ireland", "Taiwan", "Bulgaria", "Denmark", "Hungary", "Israel", "South Africa", "Bolivia", "Egypt", "Pakistan", "Romania", "Slovenia", "Thailand", "Turkey", "Venezuela" ],
"n": [ 2394, 804, 343, 247, 205, 134, 113, 112, 110, 95, 52, 51, 50, 50, 48, 47, 28, 24, 20, 18, 17, 17, 13, 12, 12, 11, 11, 11, 9, 9, 9, 9, 9, 8, 8, 7, 7, 7, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 5, 5 ],
"variable": [ "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp", "mrp" ],
"mean": [   0.06,   0.06,   0.06,   0.06,   0.06,   0.06,   0.06,   0.07,   0.05,   0.08,   0.06,   0.06,   0.07,   0.06,   0.06,   0.06,   0.07,   0.07,   0.11,   0.07,   0.07,   0.05,   0.08,   0.09,   0.06,   0.08,   0.07,   0.08,   0.07,   0.08,   0.06,   0.07,   0.05,   0.07,   0.05,   0.07,   0.06,   0.07,   0.08,   0.06,   0.08,   0.06,   0.07,   0.11,   0.09,   0.16,   0.08,   0.07,   0.08,   0.08,   0.11 ],
"sd": [   0.02,   0.02,   0.02,   0.01,   0.02,   0.02,   0.02,   0.02,   0.01,   0.02,   0.02,   0.02,   0.04,   0.02,   0.02,   0.02,   0.03,   0.02,   0.08,   0.04,   0.05,   0.02,   0.01,   0.03,   0.01,   0.03,   0.02,   0.02,   0.03,   0.01,   0.01,   0.02,   0.02,   0.01,   0.02,   0.01,   0.03,   0.02,   0.01,   0.01,   0.02,   0.01,   0.01,   0.02,   0.01,   0.01,   0.01,   0.02,   0.01,   0.03,   0.02 ],
"max": [   0.16,   0.15,   0.18,   0.11,   0.12,   0.12,   0.12,   0.12,   0.12,   0.14,   0.12,   0.12,   0.21,   0.12,   0.12,   0.12,   0.11,   0.14,   0.34,    0.2,   0.25,   0.08,    0.1,   0.13,   0.07,   0.13,    0.1,   0.11,   0.13,    0.1,   0.09,   0.08,   0.06,   0.08,   0.08,   0.09,   0.09,   0.11,   0.09,   0.07,   0.09,   0.07,   0.08,   0.12,   0.11,   0.16,   0.09,   0.08,   0.08,    0.1,   0.13 ],
"min": [ " 0.03 ", " 0.03 ", " 0.02 ", " 0.02 ", " 0.03 ", " 0.03 ", " 0.03 ", " 0.02 ", " 0.03 ", " 0.03 ", " 0.03 ", " 0.03 ", " 0.03 ", " 0.03 ", " 0.03 ", " 0.03 ", " 0.02 ", " 0.01 ", " 0.04 ", " 0.01 ", " 0.03 ", " 0.01 ", " 0.06 ", " 0.03 ", " 0.05 ", " 0.01 ", " 0.04 ", " 0.06 ", " 0.04 ", " 0.06 ", " 0.05 ", " 0.02 ", " 0.01 ", " 0.05 ", " 0.03 ", " 0.06 ", " 0.03 ", " 0.04 ", " 0.07 ", " 0.06 ", " 0.06 ", " 0.05 ", " 0.05 ", " 0.08 ", " 0.08 ", " 0.15 ", " 0.06 ", " 0.06 ", " 0.07 ", " 0.03 ", " 0.08 " ] 
},
"height":    500,
"width":    900,
"margin": {
 "top":     10,
"bottom":     10,
"right":     50,
"left":    100 
},
"x": "Country",
"y": "mean",
"radius":      3,
"sort": {
 "var": "mean" 
},
"whiskers": function(d){return [d.mean - 1.96 * d.sd, d.mean + 1.96 * d.sd]},
"tooltipLabels": [ "Country", "mean", "sd" ] 
};

        var color = d3.scale.category20();

        var svg = d3.select("body").append("svg")
            .attr("width", opts.width)
            .attr("height", opts.height)

          if(!(opts.margin)) opts.margin = { top: 10, right: 50, bottom: 20, left: 50 }

          //data transform since rCharts does not use toJSONArray() by default
          var data = [];

          opts.data[d3.keys(opts.data)[0]].forEach(function(d,i){
            var tempobj = {};
            d3.keys(opts.data).forEach(function(key){
              tempobj[key] = opts.data[key][i];
            });
            data.push(tempobj);
          });

          //if no facet then just make blank object
          if(!(opts.facet)) opts.facet = {};
          //if facet not provided for x or y make Dummy variable
          opts.facet.x = opts.facet.x ? opts.facet.x : "Dummy"
          opts.facet.y = opts.facet.y ? opts.facet.y : "Dummy"    
          if(opts.facet.x === "Dummy" || opts.facet.y === "Dummy") {
            data.forEach(function(d){
              d.Dummy = 1;
            })
          }
          var rows = d3.set(data.map(function(d){return d[opts.facet.y]})).values();
          var nrow = rows.length;
          var cols = d3.set(data.map(function(d){return d[opts.facet.x]})).values()
          var ncol = cols.length;
  
          var tuples = d3.merge(
            rows.map(function(row,irow){
              return cols.map(function(col,icol){
                return {key:row + "~" + col, values: {"row":irow, "col":icol} }
              })
            })
          );
    
          var grid = d3.layout.grid()
            .rows( nrow )
            .cols( ncol )
            .size([ opts.width, opts.height-100])
            .bands();

          var svgGrid = d3.select("#" + opts.id).append("svg")
            .attr("width", opts.width)
            .attr("height", opts.height);
          
          grid(tuples);  //apply d3-grid layout

          tuples.forEach(function(cell,cellnum) {
            // Filter the data set for the x and y facets
            var filteredData = data.filter(function(d){
              return d[opts.facet.x] == cell.key.split('~')[1]
            });
            //split for now but could easily do all in one filter
            filteredData = filteredData.filter(function(d){
              return d[opts.facet.y] == cell.key.split('~')[0]
            });
    
            filteredData = d3.nest()
              .key(function(d){ return d[opts.facet.x] + "~" + opts.facet.y} ).sortKeys(d3.ascending)
              //.key(function(d){ return d[opts.group] } )
              .entries(filteredData);

            var errorbar = d3.svg.errorbar()
              .height(grid.nodeSize()[1]- opts.margin.top - opts.margin.bottom )
              .width(grid.nodeSize()[0] - opts.margin.right - opts.margin.left)
              .xVar(opts.x)
              .yVar(opts.y)
              .colorVar(opts.color)
              .color(color)
              .radius(opts.radius)
              .tooltipLabels(opts.tooltipLabels?opts.tooltipLabels:[]);

            if(opts.whiskers) {
              if (typeof opts.whiskers === "function") {
                errorbar.whiskers(opts.whiskers)
              } else {
                errorbar.whiskers(
                  function(d) {
                    return [d[opts.whiskers[0]], d[opts.whiskers[1]]]
                  }
                );
              }
            }; 

            if(opts.sort) {
              errorbar.sort(opts.sort);
            }

            var g = svg //.selectAll("g").data(filteredData);
              .append("g").data(filteredData) //g.enter().append("g")
                .attr("transform","translate(" + (+cell.x + opts.margin.right) + "," + (+cell.y+opts.margin.top) + ")")
                .call(errorbar);

          });
      })();
      </script>
    
  </body>
</html>
